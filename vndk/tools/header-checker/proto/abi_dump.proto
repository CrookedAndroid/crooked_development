syntax = "proto2";

package abi_dump;

message BasicTypeAbi {
  required string name = 1;
  // Optional since templated types will not have this information.
  optional uint64 size = 2 [default = 0];
  optional uint32 alignment = 3 [default = 0];
}

message BasicNamedAndTypedDecl {
  required BasicTypeAbi type_abi = 1;
  required string name = 2;
  required string access = 3;
  required string linker_set_key = 4;
}

message FunctionDecl {
  required BasicNamedAndTypedDecl basic_abi = 1;
  // Mangled name.
  required string mangled_function_name = 2;
  required string source_file = 3;
  repeated ParamDecl parameters = 4;
  optional TemplateInfo template_info = 5;
}

message ParamDecl {
  required BasicNamedAndTypedDecl basic_abi = 1;
  required bool default_arg = 2;
}

message RecordFieldDecl {
  // For future additions.
  required BasicNamedAndTypedDecl basic_abi = 1;
}

message EnumFieldDecl {
  required BasicNamedAndTypedDecl basic_abi = 1;
  required int64 enum_field_value = 2; // assumption: fits int64
}

message TemplateInfo {
  repeated TemplateElement elements = 1;
}

message TemplateElement {
  required BasicTemplateElementAbi basic_abi = 1;
  message BasicTemplateElementAbi {
    optional BasicTypeAbi type_abi = 1;
    optional string name = 2;
    required string linker_set_key = 3;
  }
}

message CXXBaseSpecifier {
  required BasicCXXBaseSpecifierAbi basic_abi = 1;
  message BasicCXXBaseSpecifierAbi {
    required string name = 1;
    required string access = 2;
    required bool is_virtual = 3;
    required string linker_set_key = 4;
  }
}

message VTableComponent {
  enum Kind {
    VCallOffset = 0;
    VBaseOffset = 1;
    OffsetToTop = 2;
    RTTI = 3;
    FunctionPointer = 4;
    CompleteDtorPointer = 5;
    DeletingDtorPointer = 6;
    UnusedFunctionPointer = 7;
  }
  message BasicVTableComponentAbi {
    required Kind kind = 1;
    //TODO: Revert to required
    optional string mangled_component_name = 2;
    optional uint64 value = 3;
    required string linker_set_key = 4;
  }
  required BasicVTableComponentAbi basic_abi = 1;
}

message VTableLayout {
  repeated VTableComponent vtable_components = 1;
}

message RecordDecl {
  required BasicNamedAndTypedDecl basic_abi = 1;
  repeated RecordFieldDecl fields = 2;
  repeated CXXBaseSpecifier base_specifiers = 3;
  required string source_file = 4;
  optional TemplateInfo template_info = 5;
  required string mangled_record_name = 6;
  optional VTableLayout vtable_layout = 7;
}

message EnumDecl {
  required BasicNamedAndTypedDecl basic_abi = 1;
  repeated EnumFieldDecl enum_fields = 2;
  required string source_file = 3;
}

message TranslationUnit {
  repeated RecordDecl records = 1;
  repeated FunctionDecl functions = 2;
  repeated EnumDecl enums = 3;
}
